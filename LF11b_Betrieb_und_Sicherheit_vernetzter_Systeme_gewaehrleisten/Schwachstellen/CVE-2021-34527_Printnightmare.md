# CVE-2021-34527 - Printnightmare

Printnightmare (CVE-2021-34527) ist eine kritische Schwachstelle im Druckerwarteschlangen-Dienst (Print Spooler Service) aller Betriebssysteme von Microsoft.

Ein Angreifer kann über einen beliebigen Client mit normalen Benutzerrechten Zugriff über Netzwerkprotokolle auf den Dienst "Druckerwarteschlange" der verwundbaren Systemen zugreifen und über eine Schwachstelle in der Funktion RpcAddPrinterDriverEx() beliebigen Code im Benutzerkontext von SYSTEM ausführen (Remote Code Execution / Privilege Escalation).
Ein Angreifer köntne somit Programme installieren, auf Daten zugreifen, diese verändern oder löschen, Benutzerzugänge anlegen oder auslesen und somit in wenigen Schritten Zugriff auf das gesamte Netzwerk erlangen.

Diese Schwachstelle ist besonders brisant, da der Dienst Druckerwarteschlange standardmäßig auf allen Windows-Betriebssystemen aktiviert und gestartet ist - unter anderem auch Domänen Controllern

## Microsoft CVE-2021-34527 | Windows Print Spooler Remote Code Execution Vulnerability (englisch)

https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527

## Timeline

* 16. Februar 2011 - Windows 7 Service Pack 1 wird veröffentlicht, die älteste Windows-Version, für welche das Sicherheitsupdate am 08. Juni 2021 veröffentlicht wird. Vermutlich sind aber auch frühere Windows-Versionen bereits betroffen.

* 20. Juli 2020 - Sicherheitsforscher von Tencent Security Xuanwu Lab sowie von AFINE und NSFOCUS Tianji Lab melden eine Schwachstelle im Print Spooler Dienst (MSRC Case 60036), welcher später als CVE-2021-1675 geführt wird
* 06. August 2020 - laut dem Sicherheitsforscher von Tencent Security fragte Microsoft zu diesem Zeitpunkt nach, die gemeldete Schwachstelle bis November 2020 vertraulich zu behandeln, da weiterhin an einer Lösung gearbeitet würde
* 9. Oktober 2020 - MSRC fragt erneut nach, die Schwachstelle bis zum 12. Januar 2021 vertraulich zu behandeln, da weiterhin mehr Zeit für die Arbeit an einem Fix benötigt würde
* 11. Januar 2021 - MSRC bittet erneut darum, die Schwachstelle bis 09.03.2021 als vertraulich zu behandeln, da zwar ein Fix in Arbeit sei und auch die Veröffentlichung eines Sicherheitsupdate geplant wurde, jedoch in finalen Tests eine funktionale Einschränkung entdeckt wurde.
* 23. Februar 2021 - MSRC entdeckte eine weitere Schwachstelle in der selben Komponenten (Spooler Service) und sie würden gerne einen Fix für beide Schwachstellen zur selben Zeit veröffentlichen. Deshalb wird erneut darum gebeten, die Schwachstelle bis zum 08. Juni vertraulich zu behandeln.

* 8. Juni 2021 - Microsoft veröffentlicht die Juni Patches für die unterstützten Betriebssystemversionen und schließt damit offenbar die Schwachstelle CVE-2021-1675. Die Schwachstelle wird anfangs nur als Local Privilege Escalation einklassifiziert.
* 21. Juni 2021 - Microsoft erhöht den CVSS Wert und erweitert die Ausnutzbarkeit auf Remote Code Execution für den CVE-2021-1675
* 27. Juni 2021 - Die Sicherheitsforscher von Xianjin veröffentlichen ein GIF mit erfolgreicher Ausnutzung der Lücke, jedoch ohne technische Details oder Proof-of-Concept 
On June 29, researchers at a different firm, Sangfor, published a full technical write-up with PoC code to GitHub. That repository, however, was taken down after only a few hours. It is unclear if the researchers decided to share their PoC because of the tweet from QiAnXin. The researchers claim to have discovered this vulnerability independently from those credited with the disclosure by Microsoft.
* 29. Juni 2021 - Die Forscher einer anderen Firma, Sangfor, veröffentlichen eine vollständige technische Niederschrift mit PoC Code auf Github. Nach wenigen Stunden wird das Repository wieder entfernt. Es wurde jedoch schon sehr häufig heruntergeladen und der PoC Code wird weiter verbreitet.
* 30. Juni 2021 - verschiedene Quellen berichten, dass auch nach dem Einspielen des Sicherheitsupdates vom 08. Juni die Systeme weiterhin verwundbar sind. Relativ schnell wird die Empfehlung ausgesprochen, auf Systemen die keine Druckfunktionalität im Netzwerk bereitstellen, den Dienst Druckerwarteschlange zu deaktivieren. 
* 01. Juli 2021 - Eine weitere Empfehlung von Microsoft mit der CVE-2021-34527 wird veröffentlicht. Diese bezieht sich auf die Schwachstelle, welche bis dahin unter dem Namen "PrintNightmare" bereit Schlagzeilen gemacht hat. Obwohl die Empfelung noch nicht besonders viele Details enthält, erklärt Microsoft dass die neue CVE eine separate Schwachstelle betrachtet als der CVE-2021-1675.
* 02. Juli 2021 - Microsoft stellt erweiterte Workaround-Empfehlungen bereit, ein Patch für die aktuelle Schwachstelle ist bisher weder angekündigt noch veröffentlicht
